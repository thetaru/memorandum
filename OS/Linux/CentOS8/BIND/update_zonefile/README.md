# ゾーンファイルの更新
ゾーンファイルの更新時にやるべきこと。  
## 1. named or named-chroot?
chrootを使っているかどうかを確認する。
```
# systemctl status named
# systemctl status named-chroot
```
ゾーンファイルの配置場所がわかった。  
以降、chroot環境下であっても起点は`/`として進める。  
※ `/var/named/chroot/etc/named.conf`でも`/etc/named.conf`と書くという意味。
## 2. named.conf
更新の際に見るべきポイントは次の通り。
- directoryオプション
> 設定ファイル内に相対パスで記述したときの基準となるファイルパスを指定する。
- zoneオプション
> ドメインとゾーンファイルを指定する。  
> typeがmasterとなっているもののみ更新の対象となる。(slaveの場合はmasterから降ってくため更新不要)  
## 3. ゾーンファイルの更新1
0. バックアップの作成
```
# cp -p /var/named/exaple.com.zone{,_$(date +%Y%m%d)}
```
1. TTLの変更  

TTLを小さくしてレコードの保持期間を短くする。  
```
-  $TTL 8H
+  $TTL 600
```
2. serialの更新  

スレーブ側が持つゾーンファイルのシリアルより大きい値にしないと古いゾーンファイルと判断され、ゾーンファイルの更新が行われない。  
推奨は、`YYYYMMDDnn`(nは連番)のとなっている。
```
-  2019122502
+  2021052801
```
戻し作業で再変更する場合は、連番部分をインクリメントして対応すること。  

3. minimumの更新  
  
minimumは、ドメインが存在しないという情報を保持(ネガティブキャッシュ)する期間として利用される。  
minimumの期間内(ネガティブキャッシュ有効期限内に)に復旧した場合、キャッシュの有効期限が終わるまで復旧が遅れてしまう。  
  
多くの場合、TTLと同じ値にすることが多い。
```
-  8H
+  600
```

4. レコードの変更
レコードの変更、追加、削除を実施する。

## 4. ゾーンファイルのエラーチェック
```
# named-checkzone "example.com" /var/named/exaple.com.zone
```

## 5. ゾーンの読み込み
```
# rndc reload
```
## 6. 名前解決の確認
自分自身で引けることと名前解決を許可しているクライアントで引けることを確認する。  
もっと言えば、不許可クライアントでは引けないことも確認する。

## 7. 後片付け
レコードが伝播後は、小さい價にしたTTLとminimumの値を元に戻し、シリアルの連番をインクリメントする。  
その後、4～6の内容を再度実施する。
