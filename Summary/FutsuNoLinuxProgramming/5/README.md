# ストリームにかかわるシステムコール
## 5.1 本章で話すこと
以下のシステムコールを使用してストリームを操作することで入出力を実現します。
- read
> ストリームからバイト列を読み込む
- write
> ストリームにバイト列を書き込む
- open
> ストリームを作る
- close
> 用済みのストリームを始末する
## 5.2 ファイルディスクリプタ
プロセスがファイルを読み書きしたり他のプロセスとやりとりするときにはストリームを使います。  
このストリームをプログラムから扱うには、ファイルディスクリプタというものを使います。
### ファイルディスクリプタとは?
プログラムから見たファイルディスクリプタはただの整数値(int型)です。  
カーネルの中には、実際にストリーム(を管理するデータ型)があるのですが、ストリームを直接プロセスに見せるわけにはいきません。  
そこで、カーネルが持っているストリームと番号(i.e. ファイルディスクリプタ)を対応させることで、プロセスは番号からストリームを指定できるようになります。  
  
以上のように、ストリームと番号(ファイルディスクリプタ)の対応関係が重要になってきます。
## 5.3 標準入力、標準出力、標準エラー出力
ストリームとファイルディスクリプタの対応関係を知るにはどうすればいいでしょうか。  
一番簡単なのは、プロセスの開始時から使えることがわかっている既知のファイルディスクリプタを使うことです。  
  
シェルからプロセスが起動された場合、どのプロセスも以下の3つのストリームが用意されており、それに対応するファイルディスクリプタも固定されています。
|ファイルディスクリプタ|マクロ|説明|
|:---|:---|:---|
|0|STDIN_FILENO|標準入力|
|1|STDOUT_FILENO|標準出力|
|2|STDERR_FILENO|標準エラー|

## 5.3.1 標準入力と標準出力
コマンドを一般的に標準入力からデータを読み込み、処理結果を標準出力へ書き込むようになっています。  
標準入力はプログラムの入力元で、標準出力はプログラムの出力先だということです。  
  
`cat`: キーボード入力された文字列をモニタに出力する例
```
                          cat
+----------+  stream  +---------+  stream  +---------+
| keyboard | -------> | process | -------> | monitor |
+----------+  STDIN   +---------+  STEDOUT +---------+

```
  
`cat file`: ファイル内容をモニタに出力する例
```
                          cat
+----------+  stream  +---------+  stream   +---------+
|   file   | -------> | process | --------> | monitor |
+----------+  STDIN   +---------+  STEDOUT  +---------+

```
ここですごいのは、catプロセスは自分がファイルからデータを読み込んでいることを知らないということです。  
というのも、ファイルとプロセス間のストリーム(ここでは標準入力のこと)はシェルが管理するのでプロセスは入力元について関知しません。  
※ ファイル-プロセス間のストリームのみに限る話ではありません。  
  
`grep print < hello.c | head`
```
                          grep                        head
+----------+  stream  +---------+   stream(pipe)   +---------+  stream   +---------+
|   file   | -------> | process | ---------------> | process | --------> | monitor |
+----------+  STDIN   +---------+  STEDOUT  STDIN  +---------+  STEDOUT  +---------+

```
## 5.3.2 標準エラー出力
エラーメッセージが標準出力に出てしまうと、ユーザがそのメッセージに気付かない可能性が高いです。  
そのため、端末に繋がっている可能性がより高いストリームを余分に用意して、プログラムに渡したい標準出力に、人間に読ませたい出力は標準エラー出力に出すようにします。

## 5.4 ストリームの読み書き
ファイルディスクリプタについて説明したので、システムコールについて説明します。
## 5.4.1 read(2)
ストリームからバイト列を読み込むには、read()というシステムコールを使います。
### Syntax - read
```c
#include <unistd.h>

ssize_t read(int fd, void *buf, size_t bufsize);
```
read()は、ファイルディスクリプタfd番のストリームからバイト列を読み込むシステムコールです。  
最大bufsizeバイト読み、bufに格納します。bufのサイズをそのままbufsizeに指定するのが一般的です。  
  
read()は、読み込みが問題なく完了したときは読み込んだバイト数を返します。  
ファイル終端に達したときは0を、エラーが起きたときは-1を返します。  
  
※ 文字列を扱うシステムコールを使用する場合は、NULL文字`/0`で終端が前提かどうかを確認しましょう。
## 5.4.2 write(2)
ストリームにバイト列を書き込むには、write()というシステムコールを使います。
### Syntax - write
```c
#include <unistd.h>

ssize_t write(int fd, const void *buf, size_t bufsize);
```
write()は、bufsizeバイト分をbufからファイルディスクリプタfd番のストリームに書き込みます。  
  
write()は、正常に書き込んだときは書いたバイト数を返します。エラーが起きたときは-1を返します。  

## 5.4.3 ストリームの定義
ストリームは、ファイルディスクリプタで表現され、read()またはwrite()を呼べるもののことです。
## 5.5 ファイルを開く
## 5.5.1 open(2)
ファイルに接続するストリームを用意するためには、システムコールopen()を使います。
```c
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

int open(const char *path, int flags);
int open(const char *path, int flags, mode_t mode);
```
open()は、パスpathで表されるファイルにつながるストリームを作成し、そのストリームを指すファイルディスクリプタを返します。  
第2引数のflagsはストリームの性質を表すフラグです。
|フラグ|意味|
|:---|:---|
|O_RDONLY|読み込み専用|
|O_WRONLY|書き込み専用|
|O_RDWR|読み書き両用|
|O_CREAT|ファイルが存在しなければ新しいファイルを作る|
|O_EXCL|O_CREATとともに指定すると、すでにファイルが存在するときはエラーになる|
|O_TRUNC|O_CREATとともに指定すると、ファイルが存在するときはまずファイルの長さをゼロにする|
|O_APPEND|write()が常にファイル末尾に書き込むよう指定する|

第3引数のmodeは、flagsにO_CREATを指定したときのみ有効な引数です。  
ファイルを新しく作る場合に、そのファイルのパーミッションを指定します。
## 5.5.2 close(2)
ストリームを始末するシステムコールです。使い終わったストリームをclose()を使って始末します。
```c
#include <unistd.h>

int close(int fd);
```
close()は、ファイルディスクリプタfdに関連付けられたストリームを始末します。  
問題なくストリームを閉じられたら0を返し、エラーが起きた場合は-1を返します。
