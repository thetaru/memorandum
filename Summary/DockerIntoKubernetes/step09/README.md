# サービス
サービスとは、一時的な存在であり永続的なIPアドレスを持たないポッドに対し、クライアントがアクセスするためのオブジェクトです。
|サービスタイプ|説明|
|:---|:---|
|CluserIP|ポッドネットワーク上のポッドから内部DNSに登録された名前でアクセスできる|
|NodePort|ClusterIPのアクセス可能範囲に加えて、k8sクラスタ外のクライアントも、</br>ノードのIPアドレスとポート番号を指定することでアクセスできる|
|LoadBalancer|NodePortのアクセス可能範囲に加えて、k8sクラスタ外のクライアントも、</br>代表IPアドレスとプロトコルのポート番号でアクセスできる|
|ExternalName|k8sクラスタ内のポッドネットワーク上のクライアントから、</br>外部のIPアドレスを名前でアクセスできる。|

## 9.1 サービスタイプClusterIP
サービスのマニフェストでサービスタイプを省略するとClusterIPとして扱われます。  
- 代表IPアドレス
- 負荷分散
- DNS登録

マニフェストに`clusterIP:None`をセットした場合は、ヘッドレスモードでサービスが動作します。  
この設定では、代表IPアドレスを取得せず、負荷分散も行われません。その代わり、ポッド群のIPアドレスを内部DNSに登録し、ポッドのIPアドレス変更にも対応して最新状態を保ちます。

## 9.2 サービスタイプNodePort
ClusterIPに加えて、ノードのIPアドレスに公開用ポート番号を開きます。  
ノードの特定ポートとポッドの特定ポートを紐付けます。(ポートフォワードのような仕組み。)  
クラスタの全ノードに公開用ポートが開設され、ノードで受けたリクエストはすべてのノード上に存在するポッドを対象に負荷分散し転送されます。(設定次第で挙動を変えることも可能です。)
## 9.3 サービスタイプLoadBalancer
ロードバランサーと連携し、ポッドのアプリケーションを外部のネットワークからアクセスできるようになります。  
また、LoadBalancerはNodePortの上に作られるため、ClusterIPも自動的に作られます。
## 9.4 サービスタイプExternalName
飛ばし
## 9.5 サービスとポッドとの関連付け
サービスは転送先のポッドを決定する際にセレクターのラベルに一致するポッドをetcdから選び出し、転送先のポッドのIPアドレスを取得します。  
デプロイメントのマニフェストに対してサービスのマニフェストを作成します。  
このとき、サービスのセレクターとデプロイメントのポッドテンプレートに、同じラベルを記述します。  
ラベルが一致することで、サービスのリクエスト転送先ポッドが決まります。  
  
ラベルによる転送先の決定手法は、サービスのセレクターに設定するラベルを変更するだけで転送先のポッド群を変更できます。  
しかし、ラベルが重複してしまうと、意図しない対応関係ができてしまい、以上動作の原因となります。
## 9.6 サービスのマニフェストの書き方
デプロイメントのマニフェストとサービスのマニフェストを作成します。
```
### FileName: deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-deploy
spec:
  replicas: 3
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
        - name: nginx
          image: nginx:latest
```
```
### FileName: svc.yaml
apiVersion: v1
kind: Service
metadata:
  name: web-service
spec:
  selector:
    app: web
  ports:
    - protocol: TCP
      port: 80
```
