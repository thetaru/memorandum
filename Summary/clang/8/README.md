# メモリ管理とファイル入出力
## 8.1 動的メモリ割り当て
### 8.1.1 malloc関数とfree関数
C言語には動的メモリ割り当てを行える`malloc`という関数があります。    
malloc関数はstdlib.hに定義されています。  
そのためstring.hをインクルードする必要があります。
#### Syntax - malloc
```c
ポインタ変数 = malloc( メモリバイト数 );
```
malloc関数はメモリバイト数で割り当てた領域の先頭を指すポインタを返します。  
メモリの割り当てに失敗した場合はNULLポインタが返ってきます。  
  
割り当てたメモリはプログラムが終了するまで確保されますが、メモリが不要になった場合に自分で開放してやる必要があります。  
メモリの開放にはfree関数を使用します。
#### Syntax - free
```c
free( ポインタ変数 );
```
  
実際にint型の要素数5の配列を宣言してみます。
```c
int* p;
p = (int*)malloc( 4 * 5 );

if ( !p ) {
  printf("メモリ割り当て失敗\n");
  exit(1);
}
```
int型のサイズを4byteとして　5要素分のメモリ領域(= 4\*5 = 20byte)を確保します。  
上の場合は解説のしやすさからint型を4byteとしましたが、実際の場合は次のように`sizeof`を使って型のサイズを取得しましょう。
```c
int* p;
p = (int*)malloc( sizeof(int) * 5 );

if ( !p ) {
  printf("メモリ割り当て失敗\n");
  exit(1);
}
```
ちなみにexit関数はプログラムを終了させる関数です。  
exit関数に**0**を渡せば**正常終了**、**0以外の数値**を渡せば**異常終了**となります。
### 8.1.2 malloc関数とfree関数の使用例
実際にmalloc関数とfree関数を使ってみます。
```c
#include <stdio.h>
#include <stdlib.h>

int main(void)
{
  int* buf;
  int number, i, sum;
  
  printf("入力データ: ");
  scanf("%d", &number);
  
  buf = (int*)malloc( number * sizeof(int) );
  
  if ( !buf ) {
    printf("メモリ割り当て失敗\n");
    exit(1);
  }
  
  for ( i = 0; i < number; i++ ) {
    printf("%d個目のデータ: ", i+1);
    scanf("%d", &buf[i]);
  }
  
  for ( i = 0, sum = 0; i < number; i++ ) {
    sum += buf[i];
  }
  
  printf("合計: %d\n", sum);
  free( buf );
  return 0;
}
```
## 8.2 ファイル入出力
### 8.2.1 ストリーム
ファイル入出力においてストリームという概念があります。  
C言語では任意の入出力デバイス(e.g. キーボード、ディスプレイなど)で同じ手法で操作することになります。  
これができるのはストリームという抽象的なインターフェースを操作できるから可能なのです。
### 8.2.2 ファイル開閉
ファイルを操作する際もストリームを扱います。
### 8.2.2.1 開
はじめにファイルを開く方法について学びます。  
まずファイルを開きストリームと結びつける必要があります。  
そのためにはFILE構造体とfopen関数を使います。(どちらもstdio.hに定義されています。)
#### Syntax - ファイルの開き方
```c
FILE* fp = fopen( char* ファイル名, char* モード );
``` 
fopen関数はファイル名とファイルモードを渡すとFILE構造体のポインタを返します。  
このFILE構造体がストリームで、これらを使ってファイルの入出力を行います。  
  
ここでモードという引数をとっています、このモードは次の表にある文字列を渡すことでファイルのモードを選択できます。
|モード|説明|
|:---|:---|
|r|読み込み用にテキストファイルを開く<br />ファイルが見つからなかった場合、fopen関数はNULLを返す|
|w|書き込み用にテキストファイルを開く<br />ファイルが既に存在していた場合、その内容を破棄する|
|a|テキストファイルにデータを追加するく<br />ファイルが存在しなかった場合、ファイルを新たに作成する|
|rb|読み込み用にバイナリファイルを開く|
|wb|書き込み用にバイナリファイルを開く|
|ab|バイナリファイルにデータを追加する|
|r+|読み込み/書き込み用にテキストファイルを開く|
|w+|読み込み/書き込み用にテキストファイルを作成する|
|a+|読み込み/書き込み用にテキストファイルを追加する|

テキストモード(r,w,a)とバイナリモード(rb,wb,ab)があります。  
テキストモードでは主にASCII文字列を扱い文字変換が行われますが、バイナリモードでは文字変換は行われません。
### 8.2.2.2 閉
ファイルは開けたら必ず閉じなければなりません。  
ストリームからファイルを切り離すにはfclose関数を使用します。
#### Syntax - fclose
```c
fclose( FILE* ストリーム );
```
実際に指定したファイルが(カレントディレクトリに)存在するかどうかを確認するプログラムを作成します。
```c
#include <stdio.h>
#include <stdlib.h>

int main()
{
  char filename[1000];
  FILE* fp;
  
  printf("ファイル名: ");
  scanf("%s", filename);
  
  fp = fopen(filename, "r");
  if ( fp == NULL ) {
    printf("ファイルが開けませんでした\n");
    exit(1);
  }
  printf("ファイルを正常に開くことができました\n");
  
  fclose(fp);
  return 0;
}
```
##  8.2.3 ファイル読み込み
開いたファイルの内容を表示させてみましょう。  
ファイルから文字を取得するにはfgetc関数を使用します。
#### Syntax - fgetc関数
```c
int fgetc( FILE* ストリーム );
```
fgetc関数はストリームからunsigned char型の値を1文字読み込み、int型の値として返します。  
実際にソースファイルと同じ場所にtestfile.txtというファイルを作成してみます。
```c
#include <stdio.h>
#include <stdlib.h>

int main()
{
  char filename[100] = "test.txt";
  FILE* fp;
  int ch;
  
  fp = fopen(filename, "r");
  if ( fp == NULL ) {
    printf("ファイルが開けませんでした\n");
    exit(1);
  }
  
  for (;;) {
    ch = fgetc( fp );
    if ( ch == EOF ) {
      break;
    }
    printf("%c", ch);
  }
  printf("\n");
  
  fclose(fp);
  return 0;
}
```
