# 3.1 プログラムの配置
## 配置場所の特性
CPUはメモリ上のプログラムのみ実行できます。  
主記憶装置(メモリ)は揮発性をもつため、電気の供給を断つと記憶内容が消失してしまいます。  
そのため、CPUに実行される前のプログラムは不揮発性メモリである補助記憶装置(HDDやSSD)に配置します。

## プログラムの実行
補助記憶装置に配置した(機械語)プログラムをCPUに実行するには、まずプログラムを主記憶装置に移動させる必要があります。  
その役割はプログラムローダが担当し、補助記憶装置から主記憶装置へ読み出します。  
その後、プログラムローダは読み出したプログラムの先頭へジャンプし、目的のプログラムを実行します。

## プログラムローダのパラドックス
プログラムローダもプログラムであるため、CPUによって実行される機械語プログラムです。  
プログラムローダ自身も補助記憶装置に格納されるので、誰がプログラムローダを補助記憶装置から主記憶装置に読み出すのでしょうか?  

## BIOSの役割
実はBIOSがプログラムローダを主記憶装置に読み出しています。  
BIOSは不揮発性の記憶装置(マザボ上のROM)に書き込まれており、CPUにメモリと同列に接続されます。  
そのため、CPUからメモリと同様にアクセスでき、コンピュータに電源を入れた直後からそのまま実行することができます。  
BIOSには、補助記憶装置からOSをメモリ上に読み出し、そこへジャンプするようなプログラムが書き込まれており、これがプログラムローダの連鎖の起点となります。  
※ OSを読みだした際にプログラムローダも読み出される認識でOK?

## データの格納方式
機械語プログラムはさまざまな形式で補助記憶装置に格納されます。  
一番簡単なのは、機械語プログラムそのままのバイト列を格納する方法です。  
この方法をRaw Binaryといいます。(補助記憶装置にMBRという特殊な領域に書き込むのに使います)  
機械語列そのままのデータなので、メモリに読み出して先頭にジャンプするだけで実行できます。

## 実行ファイルの形式
WindowsならPE形式、MacならMach-O形式、Unix系ならELF形式が主流となります。  
いずれの形式も機械語列のバイト列にヘッダを付与したファイルとなっています。  
ヘッダ部分には、機械語のバイト数や各セクションのサイズなどの管理情報が含まれており、それぞれのOSでソフトウェアの動作を管理するのに使います。  
  
どの実行可能ファイルの形式であっても、基本的にメモリの特定の番地に配置する必要があります。  
もしずれた位置に配置すると、メモリ番地を扱う命令がうまく動作しなくなります。

## org疑似命令について
これまで、アセンブリ言語で書かれたプログラムは0番地から配置されることになっていましたが、実は先頭の番地を変更するための機能があります。  
その機能を持つのがorg疑似命令で、プログラムの配置場所をアセンブラに伝える役割があります。  
例えば、`org 0x7c00`と書けば、そのプログラムを0x7c00に配置したときにうまく動くように、アセンブラがラベルの番地を計算します。
  
ちなみに、0x7c00はBIOSが補助記憶装置のMBRから読み出したプログラムを配置する標準的な番地です。  
したがって、[このプログラム](https://github.com/thetaru/memorandum/blob/master/Summary/jisaku_emulator/3/HelloWorld.asm)をアセンブルしてMBRに書き込み、パソコンを起動させれば、OSの力を借りずにハローワールドできます。

## セグメンテーション
今やどんなパソコンでもマルチタスクに対応しており、同時に複数のプログラムを実行できます。  
しかし、メモリは1つしかなく、特定の番地を持つメモリ領域はただ1つなのに、プログラムの配置場所は競合しないのでしょうか?  
  
1つのパソコンで複数のプログラムを同時に動かせるのは、CPUに備わっているアドレス変換という機能のおかげです。  
プログラムから見たメモリ番地(論理アドレス)と、CPUがアクセスするメモリ番地(物理アドレス)を変換することで競合を避ける仕組みです。  
  
例えば、プログラム1は物理アドレスの0x100000に、プログラム2は物理アドレスの0x200000に配置されているが、プログラムから見たら(つまり論理アドレスとして見ると)どちらも0x400000番地から配置されているという状況が作れます。

## アドレス空間
アドレス空間とは、番地の空間のことで、0x00000000番地から0xffffffff番地までの全番地の集合と思ってよいです。  
アドレス変換のない世界では、プログラムがメモリを見るときのアドレス空間`論理アドレス空間`と、CPUがメモリを見るときのアドレス空間`物理アドレス空間`が一致します。

|セグメント名|論理アドレス空間|物理アドレス空間|
|:---|:---|:---|
|プログラムA.text|0x00400000-0x0047ffff|0x00100000-0x0017ffff|
|プログラムA.data|0x00000000-0x0007ffff|0x00180000-0x001fffff|
|プログラムB.text|0x00400000-0x0047ffff|0x00200000-0x0027ffff|
|プログラムB.data|0x00000000-0x0007ffff|0x00180000-0x002fffff|
