# 4.1 BIOS
BIOSは、周辺機器ごとの仕様の差を吸収し、統一された制御方法を提供します。  
今日では、パソコンの電源を入れた直後の初期化や、HDDから最初のプログラムローダをメモリに読み出す役割があります。  
  
BIOSを呼び出すには、必要なレジスタに値を設定してからint命令(割り込み命令)を実行します。  
intのオペランドとahレジスタの値の組み合わせでBIOSが持つ機能群の中のどれを呼び出すかを選択します。  
  
db命令は、orgと同じく疑似命令の1つで、任意のバイト値を埋め込むための命令です。(?)  
dbを使うとアセンブリ言語では表せない任意のバイト列も埋め込めます。  
  
# 4.2 BIOSの実装

# 4.3 割り込み
## 割り込みとは
割り込みとは、プログラムを実行中のCPUに割り込んで他のプログラムを実行させる機能です。  
割り込み処理用のサブルーチンを用意しておくと、CPUが割り込み要求信号を受信したときにサブルーチンを実行されます。  
  
CPUは1つの命令を実行するたびに、割り込み要求がきているかを確認します。  
要求がきていなければ次の命令を実行します。要求がきていれば、現在の作業を後で再開できるようにスタックにflagsの内容を保存し、サブルーチンを呼び出します。  
※ このflagsはeflagsのことではありません  

## 割り込みの仕様
割り込みで使うサブルーチンの中身も、一般のものと違います。  
いつ呼び出されるかわからないことを前提に処理を書く必要がある。基本的にすべてのレジスタの値は、サブルーチンの呼び出し前後で保持されていなければならない。  
処理を終えて呼び出し元に戻るのに、(retでなく)iretを使う。iretはretと同じくスタックから戻り先番地を取り出してジャンプし、flagsの復元も行います。  
  
割り込み処理用のサブルーチンを割り込みハンドラといいます。  
割り込みハンドラ呼び出しの際にflags、cs、ipがスタックにプッシュされます。  
csとは、レジスタの1つでセグメンテーション機能に関係します。csは区分けされた1つのセグメントの先頭番地を表します。  
割り込み処理では、別セグメントにあるハンドラも呼び出せるようにするために遠くにジャンプする必要があります。  
そのために、ジャンプ先のipとcsを指定する「ファージャンプ(far jump)」が使われます。  
ハンドラから戻るときに(ジャンプ元のセグメントの)csと(ジャンプ元のセグメントの)戻り先番地が必要になり、スタックに保存しておく必要があります。  
  
割り込み発生時に呼び出されるサブルーチンをどう指定するか？  
実は、サブルーチンの先頭番地を登録しておくための特別なメモリ領域(0x0000 ~ 0x3ffの1024バイト)があります。  
このメモリ領域は割り込みベクタテーブルと呼ばれ、csとipの組256個登録しておくことができます。
```
メモリ番地                 割り込み番地
         +------+------+
  0x0000 |  cs  |  ip  | 0
         +------+------+
  0x0004 |  cs  |  ip  | 1
         +------+------+
         |  ..  |  ..  |
         +------+------+
  0x03fc |  cs  |  ip  | 255
         +------+------+
```
## ソフトウェア割り込みとハードウェア割り込みの違い
ハードウェア割り込みとは、CPUの外に接続された入出力装置からの割り込みです。  
ソフトウェア割り込みとは、プログラムの中で意図的に割り込みを起こすものです。(BIOS呼び出しで使ったint命令など)  
  
# 4.4 ブートセクタ
BIOSの起動デバイスから起動プログラムをメモリに読み出す機能について考えます。  
BIOSは、コンピュータに接続された起動可能なデバイスの中から、事前に設定された優先順位に従って起動に使うデバイスを選択し、そこに書き込まれた起動プログラムをメモリに読み出します。  
  
あるデバイスが起動可能であるかを調べるのに、BIOSはそのデバイスの先頭セクタ(ブートセクタという)を調べます。  
そして、そのセクタの最後の2バイト(セクタの先頭を0x000番地とすると、0x510,0x511番地)に0x55,0xaaが書き込まれていたら、BIOSはそのデバイスが起動可能だと判断します。  
優先度の高いデバイスから、最初に見つけた起動可能デバイスの先頭セクタをメモリの0x7c00から始まる512バイトの領域へコピーします。  
コピー後、BIOSの先頭セクタ読み込みプログラムは、0x7c00へジャンプしてプログラムを終了します。  
  
複数のパーティションを持つ機器(HDDなど)のブートセクタをMBRといいます。  
反対に、1つのパーティションしか持たない機器(USBなど)のブートセクタをPBRといいます。  
  
CHS方式・LBA方式とは、HDDの中でセクタを特定するための番号を振る方法です。  
※ 現在では、LBA方式しか使われていません。  
  
LBAは、先頭セクタを0とした通し番号です。  
パーティションテーブルには32ビットでLBAを設定できるので、512バイト×2^32=2TBまでのセクタを指定できます。  
※ MBRで容量が2TBまでのHDDしか認識されないのはこのためです  
  
CHSは、HDDの内部構造にそのまま紐付いた番号です。  
  
PBRは、個々のパーティションの先頭に位置するセクタのことです。
```
         HDDなど                   USBメモリなど
    +-------------+             +-------------+
  0 |     MBR     |           0 |     PBR     |
    +-------------+             +-------------+
  1 |             |           1 | partition 1 |
... |             |         ... |             |
 62 |             |         255 |             |
    +-------------+             +-------------+
 63 |     PBR     |
    +-------------+
 64 | partition 1 |
... |             |
255 |             |
    +-------------+
256 |     PBR     |
    +-------------+
257 | partition 2 |
... |             |
511 |             |
    +-------------+
```
